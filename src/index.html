<!DOCTYPE html>
<html>
  <head>
    <title>DND Map Designer Studio Suite Liteâ„¢</title>
    <meta name="author" content="Rachel Wang">
    <meta name="author" content="Vince LaGrassa">
  </head>
  <body>
    <div id="elm-app"></div>
    
    <script src="elm-app.js"></script>
    <script>
      var app = Elm.Main.init({
        node: document.getElementById("elm-app")
      });

			// Locate the SVG element storing the map
			var mysvg = document.getElementById('map_canvas_container');
		  while (mysvg.tagName != "svg") {
				mysvg = mysvg.firstChild
		  }

      // Send in the mouse's position relative to the canvas
			mysvg.addEventListener('mousemove', e=> {
				app.ports.receiveMouseMove.send({x: e.offsetX, y: e.offsetY});
			});


      // Send in a null/Nothing value when the mouse leaves the canvas
			mysvg.addEventListener('mouseleave', e=> {
				app.ports.receiveMouseMove.send(null);
			});

			// mousedown
			mysvg.addEventListener('mousedown', e=> {
				app.ports.receiveMouseUpDown.send(true);
		  });

			// mouseup
			mysvg.addEventListener('mouseup', e=> {
				app.ports.receiveMouseUpDown.send(false);
		  });

			// Draw map onto canvas item when save button is clicked
			app.ports.sendEditState.subscribe(function(state) {
				
				if (!state) {
					
					// Locate the SVG element storing the map again in case it
					// has been changed
					var mysvg = document.getElementById('map_canvas_container');
		  		while (mysvg.tagName != "svg") {
						mysvg = mysvg.firstChild
		  		}

					// Load canvas, converg SVG to Image, draw Image onto canvas
					var canvas = document.getElementById("myCanvas");
					var ctx = canvas.getContext("2d");
					img = new Image;
					var svgAsXML = (new XMLSerializer).serializeToString( mysvg );
					img.src = 'data:image/svg+xml,' + encodeURIComponent( svgAsXML );
					ctx.drawImage(img, 0, 0);

			  }

		  });

    </script>
  </body>
</html>
